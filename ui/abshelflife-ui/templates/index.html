<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ABShelfLife UI</title>
  <style>
    body { font-family: "IBM Plex Sans", "Noto Sans", sans-serif; margin: 20px; color: #1f2937; }
    h1, h2 { margin: 0 0 12px; }
    .card { border: 1px solid #d1d5db; border-radius: 10px; padding: 12px; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; vertical-align: top; }
    th { background: #f3f4f6; position: sticky; top: 0; }
    .muted { color: #6b7280; }
    .mono { font-family: "IBM Plex Mono", "Fira Code", monospace; }
    .grid { display: grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap: 8px; align-items: end; }
    label { display: block; font-size: 12px; color: #374151; margin-bottom: 4px; }
    input, select { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; }
    button { padding: 8px 12px; border: 0; border-radius: 6px; background: #0f766e; color: #fff; cursor: pointer; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; }
    .ok { background: #dcfce7; color: #166534; }
    .no { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>
  <h1>ABShelfLife UI</h1>
  <p class="muted">Read-only view for latest and historical sync data.</p>

  {% if db_error %}
  <div class="card">
    <strong>Database not ready:</strong>
    <span class="mono">{{ db_error }}</span>
    <p class="muted">The UI will show data automatically once MariaDB is reachable and schema is initialized.</p>
  </div>
  {% endif %}

  <div class="card">
    <form method="get" class="grid">
      <div>
        <label>Target</label>
        <select name="target_id">
          <option value="">All</option>
          {% for t in targets %}<option value="{{ t }}" {% if filters.target_id == t %}selected{% endif %}>{{ t }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label>Principal</label>
        <select name="principal_id">
          <option value="">All</option>
          {% for p in principals %}<option value="{{ p }}" {% if filters.principal_id == p %}selected{% endif %}>{{ p }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label>User</label>
        <select name="user_id">
          <option value="">All</option>
          {% for u in users %}<option value="{{ u }}" {% if filters.user_id == u %}selected{% endif %}>{{ u }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label>Finished only</label>
        <select name="finished_only">
          <option value="0" {% if not filters.finished_only %}selected{% endif %}>No</option>
          <option value="1" {% if filters.finished_only %}selected{% endif %}>Yes</option>
        </select>
      </div>
      <div><button type="submit">Apply filters</button></div>
    </form>
  </div>

  <div class="card">
    <h2>Latest (max 500)</h2>
    <table>
      <thead>
      <tr>
        <th>Target</th><th>Principal</th><th>User</th><th>Item</th><th>Episode</th>
        <th>Canonical Key</th><th>Progress</th><th>Finished</th><th>Last Update</th><th>Source</th>
      </tr>
      </thead>
      <tbody>
      {% for r in latest_rows %}
      <tr>
        <td class="mono">{{ r.target_id }}</td>
        <td class="mono">{{ r.principal_id }}</td>
        <td class="mono">{{ r.user_id }}</td>
        <td class="mono">{{ r.library_item_id }}</td>
        <td class="mono">{{ r.episode_id }}</td>
        <td class="mono">{{ r.canonical_key or '' }}</td>
        <td>{{ '%.3f'|format(r.progress or 0) }}</td>
        <td>{% if r.is_finished %}<span class="pill ok">yes</span>{% else %}<span class="pill no">no</span>{% endif %}</td>
        <td>{{ r.last_update_iso }}</td>
        <td class="mono">{{ r.source }}</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2>History (latest 300 rows)</h2>
    <table>
      <thead>
      <tr>
        <th>ID</th><th>Target</th><th>Principal</th><th>User</th><th>Item</th><th>Episode</th>
        <th>Canonical Key</th><th>Finished</th><th>Last Update</th><th>Source</th>
      </tr>
      </thead>
      <tbody>
      {% for r in history_rows %}
      <tr>
        <td>{{ r.id }}</td>
        <td class="mono">{{ r.target_id }}</td>
        <td class="mono">{{ r.principal_id }}</td>
        <td class="mono">{{ r.user_id }}</td>
        <td class="mono">{{ r.library_item_id }}</td>
        <td class="mono">{{ r.episode_id }}</td>
        <td class="mono">{{ r.canonical_key or '' }}</td>
        <td>{% if r.is_finished %}<span class="pill ok">yes</span>{% else %}<span class="pill no">no</span>{% endif %}</td>
        <td>{{ r.last_update_iso }}</td>
        <td class="mono">{{ r.source }}</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>
