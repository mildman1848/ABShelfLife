#!/usr/bin/with-contenv bash
# shellcheck shell=bash
set -euo pipefail

export DB_HOST="${DB_HOST:-127.0.0.1}"
export DB_PORT="${DB_PORT:-3306}"
export DB_NAME="${DB_NAME:-${ABS_DB_NAME:-abshelflife}}"
export DB_USER="${DB_USER:-${ABS_DB_USER:-abshelflife}}"
export TARGETS_FILE="${TARGETS_FILE:-${ABS_TARGETS_FILE:-/config/app/targets.json}}"
export MANUAL_SYNC_TRIGGER_FILE="${MANUAL_SYNC_TRIGGER_FILE:-${ABS_SYNC_TRIGGER_FILE:-/config/app/run-now.trigger}}"
export ABS_SYNC_INTERVAL_SECONDS_DEFAULT="${ABS_SYNC_INTERVAL_SECONDS_DEFAULT:-${ABS_SYNC_INTERVAL_SECONDS:-300}}"
export PORT="${PORT:-8080}"

if [[ -z "${DB_PASSWORD:-}" && -n "${ABS_DB_PASSWORD:-}" ]]; then
  export DB_PASSWORD="${ABS_DB_PASSWORD}"
fi

cd /opt/abshelflife/ui

if [[ -z ${LSIO_NON_ROOT_USER:-} ]]; then
  exec s6-setuidgid abc /opt/venv/bin/python app.py
fi

exec /opt/venv/bin/python app.py
