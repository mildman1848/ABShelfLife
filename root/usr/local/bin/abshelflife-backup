#!/usr/bin/with-contenv bash
# shellcheck shell=bash
set -euo pipefail

BACKUP_DIR="${BACKUP_DIR:-/config/backups}"
BACKUP_RETENTION_DAYS="${BACKUP_RETENTION_DAYS:-14}"
ABS_DB_NAME="${ABS_DB_NAME:-abshelflife}"

DB_USER="${ABS_BACKUP_DB_USER:-${ABS_DB_USER:-abshelflife}}"
DB_PASS="${ABS_BACKUP_DB_PASSWORD:-${ABS_DB_PASSWORD:-}}"

mkdir -p "${BACKUP_DIR}"
backup_file="${BACKUP_DIR}/abshelflife_${ABS_DB_NAME}_$(date -u +'%Y%m%dT%H%M%SZ').sql.gz"
tmp_file="${backup_file}.tmp"

echo "[backup] writing ${backup_file}"
if [[ "${DB_USER}" == "root" ]]; then
  ROOT_PASS="${DB_PASS:-${MYSQL_ROOT_PASSWORD:-}}"
  if [[ -n "${ROOT_PASS}" ]]; then
    mariadb-dump -uroot -p"${ROOT_PASS}" "${ABS_DB_NAME}" | gzip -9 > "${tmp_file}"
  else
    mariadb-dump -uroot "${ABS_DB_NAME}" | gzip -9 > "${tmp_file}"
  fi
else
  if [[ -z "${DB_PASS}" ]]; then
    echo "[backup] missing password for user ${DB_USER}. Set ABS_BACKUP_DB_PASSWORD or ABS_DB_PASSWORD."
    exit 1
  fi
  mariadb-dump -h 127.0.0.1 -P 3306 -u "${DB_USER}" -p"${DB_PASS}" "${ABS_DB_NAME}" | gzip -9 > "${tmp_file}"
fi

mv -f "${tmp_file}" "${backup_file}"
find "${BACKUP_DIR}" -type f -name '*.sql.gz' -mtime +"${BACKUP_RETENTION_DAYS}" -delete
echo "[backup] backup complete"
