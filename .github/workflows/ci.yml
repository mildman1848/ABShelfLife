name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-validate:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Lint single-container Dockerfiles
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace hadolint/hadolint \
            hadolint --config .hadolint.yaml Dockerfile Dockerfile.aarch64

      - name: Validate shell scripts
        run: |
          set -e
          find root -type f \( -name "*.sh" -o -name "run" -o -name "finish" -o -name "abshelflife-*" \) -print0 \
            | xargs -0 -I{} bash -n "{}"

      - name: Validate compose file
        run: docker compose -f docker-compose.example.yml config >/dev/null

      - name: Validate UI python syntax
        run: python3 -m py_compile ui/abshelflife-ui/app.py

  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: lint-and-validate
    strategy:
      fail-fast: false
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read version
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '\n\r')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build single image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: ${{ matrix.platform }}
          push: false
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp || github.run_id }}
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
